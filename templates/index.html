<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Motosiklet YatÄ±rÄ±m Analizi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .option-block { padding: 1rem; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 1rem; background: #f9f9f9; position: relative; }
    .remove-btn { position: absolute; right: 10px; top: 10px; color: red; cursor: pointer; }
    .details-row { background: #f1f1f1; }
    .toggle-btn { cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">ğŸï¸ Motosiklet YatÄ±rÄ±m KarÅŸÄ±laÅŸtÄ±rma AracÄ±</h1>

  <form method="post" id="mainForm">
    <div class="mb-3">
      <label>BaÅŸlangÄ±Ã§ Tarihi</label>
      <div class="d-flex gap-2">
        <select name="start_month" class="form-select" style="max-width: 150px;" required>
          {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if form_data.start_month == m %}selected{% endif %}>{{ "{:02d}".format(m) }}</option>
          {% endfor %}
        </select>
        <select name="start_year" class="form-select" style="max-width: 150px;" required>
          {% for y in range(2024, 2031) %}
            <option value="{{ y }}" {% if form_data.start_year == y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="auto_end" name="auto_end" onchange="toggleEndDate()" {% if form_data.auto_end %}checked{% endif %}>
      <label class="form-check-label" for="auto_end">Vadesi en uzun olana kadar yatÄ±rÄ±m yap</label>
    </div>

    <div id="end-date-block" {% if form_data.auto_end %}style="display:none;"{% endif %}>
      <label>BitiÅŸ Tarihi</label>
      <div class="d-flex gap-2 mb-3">
        <select name="end_month" class="form-select" style="max-width: 150px;">
          {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if form_data.end_month == m %}selected{% endif %}>{{ "{:02d}".format(m) }}</option>
          {% endfor %}
        </select>
        <select name="end_year" class="form-select" style="max-width: 150px;">
          {% for y in range(2025, 2031) %}
            <option value="{{ y }}" {% if form_data.end_year == y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="mb-3">
      <label>BaÅŸlangÄ±Ã§ AltÄ±n YatÄ±rÄ±mÄ± (â‚º)</label>
      <input type="number" step="any" name="initial_investment" value="{{ form_data.initial_investment or '' }}" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>AylÄ±k AltÄ±n AlÄ±mÄ± (â‚º)</label>
      <input type="number" step="any" name="monthly_contribution" value="{{ form_data.monthly_contribution or '' }}" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>YÄ±llÄ±k YatÄ±rÄ±m Getirisi (%)</label>
      <input type="number" step="any" name="annual_return" value="{{ form_data.annual_return or '35' }}" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Her YÄ±l AylÄ±k YatÄ±rÄ±m ArtÄ±ÅŸÄ± (%)</label>
      <input type="number" step="any" name="annual_increase" value="{{ form_data.annual_increase or '35' }}" class="form-control" required>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="future_purchase" name="future_purchase" onchange="toggleFuturePurchase()" {% if form_data.future_purchase %}checked{% endif %}>
      <label class="form-check-label" for="future_purchase">Motor ileriki bir tarihte alÄ±nacak</label>
    </div>

    <div id="future-purchase-date" class="mb-3" {% if not form_data.future_purchase %}style="display:none;"{% endif %}>
      <label>Motor AlÄ±m Tarihi</label>
      <div class="d-flex gap-2">
        <select name="purchase_month" class="form-select" style="max-width: 150px;">
          {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if form_data.purchase_month == m %}selected{% endif %}>{{ "{:02d}".format(m) }}</option>
          {% endfor %}
        </select>
        <select name="purchase_year" class="form-select" style="max-width: 150px;">
          {% for y in range(2025, 2031) %}
            <option value="{{ y }}" {% if form_data.purchase_year == y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <hr>
    <h4>ğŸ›µ Motosiklet SatÄ±n Alma SeÃ§enekleri</h4>
    <div id="options-container">
      {{ form_data.option_html | safe }}
    </div>

    <button type="button" class="btn btn-secondary mb-3" onclick="addOption()">+ SeÃ§enek Ekle</button>
    <hr>
    <button type="submit" class="btn btn-primary">Hesapla</button>
<div class="form-check mb-3 mt-3">
  <input class="form-check-input" type="checkbox" id="best_sort" onchange="handleBestSort()">
  <label class="form-check-label" for="best_sort">En karlÄ±ya gÃ¶re sÄ±rala</label>
</div>

    <button type="button" class="btn btn-outline-danger" onclick="window.location.href='/'">Temizle</button>
  </form>

  {% if results %}
    <h2 class="mt-5">ğŸ“Š SonuÃ§lar</h2>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle" style="font-size: 1.05rem;">
        <thead class="table-light">
          <tr>
            <th style="width: 40px;"></th>
            <th class="text-center sortable" onclick="sortTable(1, 'text')">â¬ <span>SeÃ§enek</span></th>
            <th class="sortable" onclick="sortTable(2, 'number')">â¬ Toplam Ã–deme</th>
            <th class="sortable" onclick="sortTable(3, 'number')">â¬ Son Taksit SonrasÄ± Kalan YatÄ±rÄ±m</th>
            <th class="sortable" onclick="sortTable(4, 'number')">â¬ Toplam VarlÄ±k (Motorun Bedeli + YatÄ±rÄ±m)</th>
            <th class="sortable" onclick="sortTable(5, 'number')">â¬ SatÄ±n alÄ±m yapmayÄ±p yatÄ±rÄ±ma devam etseydin</th>
            <th class="sortable" onclick="sortTable(6, 'number')">â¬ Fark</th>
          </tr>
        </thead>

        <tbody>
          {% for row in results %}
            <tr>
              <td class="toggle-btn" onclick="toggleDetails({{ loop.index0 }})">â–¶</td>
              <td class="text-center">{{ row.label }}</td>
              <td>{{ row.payment }} â‚º</td>
              <td>{{ row.remaining }} â‚º</td>
              <td>{{ row.combined }} â‚º</td>
              <td>{{ row.investment_only }} â‚º</td>
              <td>{{ row.difference }} â‚º</td>
            </tr>
            <tr id="details-{{ loop.index0 }}" class="details-row" style="display: none;">
              <td colspan="7" class="text-start">
                <b>ğŸ§¾ SatÄ±n Alma DetayÄ±:</b>
                <ul>
                  {% for item in row.schedule %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="alert alert-info mt-3">
      <strong>Fark:</strong> EÄŸer motosiklet satÄ±n almak yerine tÃ¼m sÃ¼re boyunca yatÄ±rÄ±m yapsaydÄ±nÄ±z, elinizdeki toplam varlÄ±k ile motosiklet satÄ±n aldÄ±ktan sonra kalan yatÄ±rÄ±mÄ±n farkÄ±dÄ±r.
      <br><em>Ã–rnek:</em> EÄŸer motosiklet + yatÄ±rÄ±m deÄŸeri 180.000 â‚º, sadece yatÄ±rÄ±m yapsaydÄ±nÄ±z 200.000 â‚º olsaydÄ± â†’ <b>Fark = -20.000 â‚º</b>
    </div>
  {% endif %}
</div>

<script>
  let optionCount = {{ form_data.option_count or 0 }};

  function addOption(existingHTML = null) {
    optionCount++;
    const container = document.getElementById("options-container");

    if (existingHTML) {
      container.insertAdjacentHTML('beforeend', existingHTML);
      return;
    }

    const div = document.createElement("div");
    div.classList.add("option-block");
    div.innerHTML = `
      <span class="remove-btn" onclick="this.parentElement.remove()">ğŸ—‘ï¸</span>
      <div class="mb-2"><label>SeÃ§enek Etiketi</label><input type="text" name="label_${optionCount}" class="form-control" required></div>
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="cash_${optionCount}" name="cash_${optionCount}" onchange="toggleInputs(${optionCount})">
        <label class="form-check-label" for="cash_${optionCount}">Nakit AlÄ±m</label>
      </div>
      <div id="installment_inputs_${optionCount}">
        <div class="mb-2"><label>PeÅŸinat (â‚º)</label><input type="number" name="pesinat_${optionCount}" class="form-control"></div>
        <div class="mb-2"><label>AylÄ±k Taksit (â‚º)</label><input type="number" name="aylik_${optionCount}" class="form-control"></div>
        <div class="mb-2"><label>Vade (Ay)</label><input type="number" name="vade_${optionCount}" class="form-control"></div>
      </div>
      <div class="mb-2" id="cash_input_${optionCount}" style="display:none;">
        <label>Nakit FiyatÄ± (â‚º)</label><input type="number" name="pesinat_${optionCount}" class="form-control">
      </div>`;
    container.appendChild(div);
  }

  function toggleInputs(id) {
    const isCash = document.getElementById(`cash_${id}`).checked;
    document.getElementById(`installment_inputs_${id}`).style.display = isCash ? "none" : "block";
    document.getElementById(`cash_input_${id}`).style.display = isCash ? "block" : "none";
  }

  function toggleDetails(index) {
    const row = document.getElementById(`details-${index}`);
    const toggleIcon = row.previousElementSibling.querySelector('.toggle-btn');
    row.style.display = row.style.display === "none" ? "table-row" : "none";
    toggleIcon.textContent = row.style.display === "table-row" ? "â–¼" : "â–¶";
  }

  function toggleEndDate() {
    const block = document.getElementById("end-date-block");
    block.style.display = document.getElementById("auto_end").checked ? "none" : "block";
  }

  window.onload = () => {
    handleBestSort();
    toggleFuturePurchase();
    toggleEndDate();
  };

  function toggleFuturePurchase() {
    const block = document.getElementById("future-purchase-date");
    block.style.display = document.getElementById("future_purchase").checked ? "block" : "none";
  }

  let sortDirection = {};

  
  let manualSort = false;

  
function sortTable(columnIndex, type, forceBest = false) {
    if (!forceBest) {
        manualSort = true;
        const bestSortBox = document.getElementById("best_sort");
        if (bestSortBox && bestSortBox.checked) {
            bestSortBox.checked = false;
        }
    }

    manualSort = true;
    const bestSortBox = document.getElementById("best_sort");
    if (bestSortBox && bestSortBox.checked) {
      bestSortBox.checked = false;
    }
    // ... geri kalan sÄ±ralama kodu zaten mevcut

    const table = document.querySelector("table");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr")).filter(row => !row.classList.contains("details-row"));
    const details = Array.from(tbody.querySelectorAll("tr.details-row"));

    const currentDirection = sortDirection[columnIndex] || "desc";
    const newDirection = currentDirection === "asc" ? "desc" : "asc";
    sortDirection[columnIndex] = newDirection;

    rows.sort((a, b) => {
      let aText = a.children[columnIndex].textContent.trim().replace("â‚º", "").replace(",", "").replace(".", "");
      let bText = b.children[columnIndex].textContent.trim().replace("â‚º", "").replace(",", "").replace(".", "");

      if (type === "number") {
        aText = parseFloat(aText) || 0;
        bText = parseFloat(bText) || 0;
      }

      if (aText < bText) return newDirection === "asc" ? -1 : 1;
      if (aText > bText) return newDirection === "asc" ? 1 : -1;
      return 0;
    });

    // tabloyu gÃ¼ncelle
    for (let i = 0; i < rows.length; i++) {
      const detailRow = details[i];
      tbody.appendChild(rows[i]);
      tbody.appendChild(detailRow);
    }
  }


function handleBestSort() {
  const box = document.getElementById("best_sort");
  if (!box || !box.checked) return;
  sortTable(6, 'number', true);  // sadece en karlÄ±ya gÃ¶re sÄ±rala
}


</script>
</body>
</html>

<div class="mt-5 p-3 bg-light border rounded">
  <h5>ğŸ“˜ KÃ¢rlÄ±lÄ±k NasÄ±l HesaplanÄ±r?</h5>
  <p>Tablodaki "Fark" sÃ¼tunu, motosiklet aldÄ±ktan sonra elinde kalan yatÄ±rÄ±m ile hiÃ§ motosiklet almadan sadece yatÄ±rÄ±m yapsaydÄ±nÄ±z elde edeceÄŸiniz tutar arasÄ±ndaki farkÄ± gÃ¶sterir.</p>
  <p><b>Ã–rnek:</b> Motosiklet alÄ±ndÄ±ktan sonra kalan yatÄ±rÄ±m 120.000 â‚º ve toplam Ã¶deme 80.000 â‚º ise: <br>
  <b>Motor + YatÄ±rÄ±m:</b> 200.000 â‚º olur. <br>
  EÄŸer sadece yatÄ±rÄ±m yapsaydÄ±nÄ±z toplam varlÄ±k 220.000 â‚º olsaydÄ±, <br>
  <b>Fark = 200.000 â‚º - 220.000 â‚º = -20.000 â‚º</b> olarak hesaplanÄ±r.</p>
  <p><i>Bu deÄŸer negatifse, sadece yatÄ±rÄ±m yapmak daha karlÄ± olurdu.</i></p>
</div>
